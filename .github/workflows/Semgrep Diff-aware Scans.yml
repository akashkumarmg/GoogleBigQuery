name: "Semgrep Diff-aware Scans" # well commented workflow

on:
  pull_request:
    branches:
      - main  # Trigger the workflow on pull requests targeting the main branch
 
permissions:
  issues: write
  pull-requests: write
  contents: read

jobs:
  build:
    runs-on: ubuntu-latest  # Use the latest stable Ubuntu runner

    steps:
      # Step 1: Checkout the main branch to capture the current baseline scan
      - name: Checkout Main Branch
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Ensure full git history is available for diff comparison
          ref: main       # Explicitly checkout the main branch

      # Step 2: Run Semgrep on the main branch to create a baseline result set
      - name: Scan Main Branch
        run: | 
          # Install dependencies for Python virtual environment and JSON processing
          sudo apt install -y python3-venv jq

          # Set up and activate virtual environment
          python3 -m venv .venv
          . .venv/bin/activate

          # Install Semgrep
          pip install semgrep

          # Perform a full scan of the main branch and save results as JSON
          semgrep --config auto --severity ERROR --json-output=main_branch_results.json

          # Extract just the results array for easier handling
          cat main_branch_results.json | jq .results > pretty-main_branch_results.json

          # Store current main branch commit SHA for diff comparison
          echo "MAIN_BRANCH_COMMIT_SHA=$(git rev-parse HEAD)" >> $GITHUB_ENV

      # Step 3: Display main branch scan results (baseline findings)
      - name: Display Main Branch Findings
        run: cat pretty-main_branch_results.json

      # Step 4: Checkout the pull request's branch (HEAD) for scanning and comparison
      - name: Checkout PR Branch
        uses: actions/checkout@v3
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          fetch-depth: 0  # Full history needed for accurate baseline diff

      # Step 5: Capture the pull request commit SHA for linking file results later
      - name: Get PR SHA
        run: echo "PR_SHA=${{ github.event.pull_request.head.sha }}" >> $GITHUB_ENV

      # Step 6: Run Semgrep on the PR branch using main as the baseline commit
      - name: Scan PR Branch with Baseline Commit (Diff-Aware)
        env:
          BASELINE_SHA: ${{ env.MAIN_BRANCH_COMMIT_SHA }}
        run: |
          echo "Using baseline commit: $BASELINE_SHA"

          # Re-install tools and Semgrep in a clean venv for consistency
          sudo apt install -y python3-venv jq
          python3 -m venv .venv
          . .venv/bin/activate
          pip install semgrep

          # Run Semgrep with diff-aware analysis using the baseline commit SHA
          semgrep --config auto --baseline-commit "$BASELINE_SHA" --severity ERROR --json-output=pr_branch_results.json

          # Format results for later parsing and posting
          cat pr_branch_results.json | jq .results > pretty-pr_branch_results.json

      # Step 7: Parse and post summarized Semgrep findings directly as a PR comment
      - name: Display new findings and Comment on PR Findings
        env:
          PR_NUMBER: ${{ github.event.pull_request.number }}
          REPO: ${{ github.repository }}
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          PR_SHA: ${{ env.PR_SHA }}
        run: |
          # Filter out only ERROR severity results
          PR_FINDINGS=$(jq '[.[] | select(.extra.severity == "ERROR")]' pretty-pr_branch_results.json)
          COUNT=$(echo "$PR_FINDINGS" | jq 'length')
          echo "Total findings: $COUNT"

          COMMENT_FILE="semgrep_comment.md"
          echo "" > "$COMMENT_FILE"

          if [ "$COUNT" -eq 0 ]; then
            # No issues found in PR branch â€” post positive result
            echo "**Semgrep Findings:** âœ… No new issues introduced. Safe to merge." > "$COMMENT_FILE"
          else
            # Findings detected â€” summarize and present top issues
            echo "### ðŸ›¡ï¸ Semgrep Findings â€” $COUNT issue(s) found" >> "$COMMENT_FILE"
            echo -e "\nShowing first 3 findings below. [Download full JSON report to view all findings from Artifacts in summary.]\n\n---" >> "$COMMENT_FILE"

            FINDINGS_ARRAY=$(echo "$PR_FINDINGS" | jq -c '.')
            MAX_DISPLAY=3
            DISPLAY_COUNT=$((COUNT < MAX_DISPLAY ? COUNT : MAX_DISPLAY))

            # Loop through and format the top 3 findings for display
            for ((i = 0; i < DISPLAY_COUNT; i++)); do
              finding=$(echo "$FINDINGS_ARRAY" | jq -c ".[$i]")

              SEVERITY=$(echo "$finding" | jq -r '.extra.severity')
              FILE=$(echo "$finding" | jq -r '.path')
              LINE=$(echo "$finding" | jq -r '.start.line')
              MSG=$(echo "$finding" | jq -r '.extra.message')
              RULE_LINK=$(echo "$finding" | jq -r '.extra.metadata.source')

              # Fallbacks for missing rule documentation links
              if [ "$RULE_LINK" == "null" ]; then
                RULE_LINK=$(echo "$finding" | jq -r '.extra.metadata.shortlink')
                if [ "$RULE_LINK" == "null" ]; then
                  RULE_LINK="https://semgrep.dev/r/$(echo "$finding" | jq -r '.check_id')"
                fi
              fi

              # Generate GitHub link to file and line in PR diff
              LINK_TO_FILE="https://github.com/$REPO/blob/$PR_SHA/$FILE#L$LINE"

              {
                echo ""
                echo "#### âš ï¸ Issue $((i+1)) â€” $SEVERITY"
                echo ""
                echo "ðŸ“„ \`$FILE:$LINE\`"
                echo "ðŸ”— [View in PR]($LINK_TO_FILE)"
                echo "ðŸ“˜ [Rule Documentation]($RULE_LINK)"
                echo "ðŸ’¬ _\"$MSG\"_"
                echo ""
                echo "---"
              } >> "$COMMENT_FILE"
            done
          fi

          # Show final markdown comment preview in workflow logs
          echo "Final Comment Preview:"
          cat "$COMMENT_FILE"

          # Post comment to PR using GitHub API
          curl -s -X POST \
            -H "Authorization: token $GH_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$(jq -n --rawfile body "$COMMENT_FILE" '{body: $body}')" \
            "https://api.github.com/repos/$REPO/issues/$PR_NUMBER/comments"

      # Step 8: Upload full Semgrep results as an artifact for detailed review
      - name: Upload full Semgrep findings as artifact
        uses: actions/upload-artifact@v4
        with:
          name: semgrep-findings
          path: pretty-pr_branch_results.json
